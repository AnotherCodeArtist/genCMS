// name: sammy
// version: 0.7.4

// Sammy.js / http://sammyjs.org

(function(e){if(typeof define==="function"&&define.amd){define(["jquery"],e)}else{$.sammy=window.Sammy=e($)}})(function(e){var t,n="([^/]+)",r=/:([\w\d]+)/g,i=/\?([^#]*)?$/,s=function(e){return Array.prototype.slice.call(e)},o=function(e){return Object.prototype.toString.call(e)==="[object Function]"},u=function(e){return Object.prototype.toString.call(e)==="[object Array]"},a=function(e){return Object.prototype.toString.call(e)==="[object RegExp]"},f=function(e){return decodeURIComponent((e||"").replace(/\+/g," "))},l=encodeURIComponent,c=function(e){return String(e).replace(/&(?!\w+;)/g,"&").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},h=function(e){return function(){return this.route.apply(this,[e].concat(Array.prototype.slice.call(arguments)))}},p={},d=!!(window.history&&history.pushState),v=[];t=function(){var n=s(arguments),r,i;t.apps=t.apps||{};if(n.length===0||n[0]&&o(n[0])){return t.apply(t,["body"].concat(n))}else if(typeof (i=n.shift())=="string"){r=t.apps[i]||new t.Application;r.element_selector=i;if(n.length>0){e.each(n,function(e,t){r.use(t)})}if(r.element_selector!=i){delete t.apps[i]}t.apps[r.element_selector]=r;return r}};t.VERSION="0.7.4";t.addLogger=function(e){v.push(e)};t.log=function(){var n=s(arguments);n.unshift("["+Date()+"]");e.each(v,function(e,r){r.apply(t,n)})};if(typeof window.console!="undefined"){if(o(window.console.log.apply)){t.addLogger(function(){window.console.log.apply(window.console,arguments)})}else{t.addLogger(function(){window.console.log(arguments)})}}else if(typeof console!="undefined"){t.addLogger(function(){console.log.apply(console,arguments)})}e.extend(t,{makeArray:s,isFunction:o,isArray:u});t.Object=function(t){return e.extend(this,t||{})};e.extend(t.Object.prototype,{escapeHTML:c,h:c,toHash:function(){var t={};e.each(this,function(e,n){if(!o(n)){t[e]=n}});return t},toHTML:function(){var t="";e.each(this,function(e,n){if(!o(n)){t+="<strong>"+e+"</strong> "+n+"<br />"}});return t},keys:function(e){var t=[];for(var n in this){if(!o(this[n])||!e){t.push(n)}}return t},has:function(t){return this[t]&&e.trim(this[t].toString())!==""},join:function(){var e=s(arguments);var t=e.shift();return e.join(t)},log:function(){t.log.apply(t,arguments)},toString:function(t){var n=[];e.each(this,function(e,r){if(!o(r)||t){n.push('"'+e+'": '+r.toString())}});return"Sammy.Object: {"+n.join(",")+"}"}});t.targetIsThisWindow=function(n){var r=e(n.target).attr("target");if(!r||r===window.name||r==="_self"){return true}if(r==="_blank"){return false}if(r==="top"&&window===window.top){return true}return false};t.DefaultLocationProxy=function(e,t){this.app=e;this.is_native=false;this.has_history=d;this._startPolling(t)};t.DefaultLocationProxy.fullPath=function(e){var t=e.toString().match(/^[^#]*(#.+)$/);var n=t?t[1]:"";return[e.pathname,e.search,n].join("")};e.extend(t.DefaultLocationProxy.prototype,{bind:function(){var n=this,r=this.app,i=t.DefaultLocationProxy;e(window).bind("hashchange."+this.app.eventNamespace(),function(e,t){if(n.is_native===false&&!t){n.is_native=true;window.clearInterval(i._interval);i._interval=null}r.trigger("location-changed")});if(d&&!r.disable_push_state){e(window).bind("popstate."+this.app.eventNamespace(),function(e){r.trigger("location-changed")});e(document).delegate("a","click.history-"+this.app.eventNamespace(),function(e){if(e.isDefaultPrevented()||e.metaKey||e.ctrlKey){return}var s=i.fullPath(this),o=this.hostname?this.hostname:function(e){var t=document.createElement("a");t.href=e.href;return t.hostname}(this);if(o==window.location.hostname&&r.lookupRoute("get",s)&&t.targetIsThisWindow(e)){e.preventDefault();n.setLocation(s);return false}})}if(!i._bindings){i._bindings=0}i._bindings++},unbind:function(){e(window).unbind("hashchange."+this.app.eventNamespace());e(window).unbind("popstate."+this.app.eventNamespace());e(document).undelegate("a","click.history-"+this.app.eventNamespace());t.DefaultLocationProxy._bindings--;if(t.DefaultLocationProxy._bindings<=0){window.clearInterval(t.DefaultLocationProxy._interval);t.DefaultLocationProxy._interval=null}},getLocation:function(){return t.DefaultLocationProxy.fullPath(window.location)},setLocation:function(e){if(/^([^#\/]|$)/.test(e)){if(d&&!this.app.disable_push_state){e="/"+e}else{e="#!/"+e}}if(e!=this.getLocation()){if(d&&!this.app.disable_push_state&&/^\//.test(e)){history.pushState({path:e},window.title,e);this.app.trigger("location-changed")}else{return window.location=e}}},_startPolling:function(n){var r=this;if(!t.DefaultLocationProxy._interval){if(!n){n=10}var i=function(){var n=r.getLocation();if(typeof t.DefaultLocationProxy._last_location=="undefined"||n!=t.DefaultLocationProxy._last_location){window.setTimeout(function(){e(window).trigger("hashchange",[true])},0)}t.DefaultLocationProxy._last_location=n};i();t.DefaultLocationProxy._interval=window.setInterval(i,n)}}});t.Application=function(e){var n=this;this.routes={};this.listeners=new t.Object({});this.arounds=[];this.befores=[];this.namespace=(new Date).getTime()+"-"+parseInt(Math.random()*1e3,10);this.context_prototype=function(){t.EventContext.apply(this,arguments)};this.context_prototype.prototype=new t.EventContext;if(o(e)){e.apply(this,[this])}if(!this._location_proxy){this.setLocationProxy(new t.DefaultLocationProxy(this,this.run_interval_every))}if(this.debug){this.bindToAllEvents(function(e,t){n.log(n.toString(),e.cleaned_type,t||{})})}};t.Application.prototype=e.extend({},t.Object.prototype,{ROUTE_VERBS:["get","post","put","delete"],APP_EVENTS:["run","unload","lookup-route","run-route","route-found","event-context-before","event-context-after","changed","error","check-form-submission","redirect","location-changed"],_last_route:null,_location_proxy:null,_running:false,element_selector:"body",debug:false,raise_errors:false,run_interval_every:50,disable_push_state:false,template_engine:null,toString:function(){return"Sammy.Application:"+this.element_selector},$element:function(t){return t?e(this.element_selector).find(t):e(this.element_selector)},use:function(){var e=s(arguments),n=e.shift(),r=n||"";try{e.unshift(this);if(typeof n=="string"){r="Sammy."+n;n=t[n]}n.apply(this,e)}catch(i){if(typeof n==="undefined"){this.error("Plugin Error: called use() but plugin ("+r.toString()+") is not defined",i)}else if(!o(n)){this.error("Plugin Error: called use() but '"+r.toString()+"' is not a function",i)}else{this.error("Plugin Error",i)}}return this},setLocationProxy:function(e){var t=this._location_proxy;this._location_proxy=e;if(this.isRunning()){if(t){t.unbind()}this._location_proxy.bind()}},log:function(){t.log.apply(t,Array.prototype.concat.apply([this.element_selector],arguments))},route:function(t,i){var s=this,u=[],a,f,l=Array.prototype.slice.call(arguments,2);if(l.length===0&&o(i)){i=t;l=[i];t="any"}t=t.toLowerCase();if(i.constructor==String){r.lastIndex=0;while((f=r.exec(i))!==null){u.push(f[1])}i=new RegExp(i.replace(r,n)+"$")}e.each(l,function(e,t){if(typeof t==="string"){l[e]=s[t]}});a=function(e){var t={verb:e,path:i,callback:l,param_names:u};s.routes[e]=s.routes[e]||[];s.routes[e].push(t)};if(t==="any"){e.each(this.ROUTE_VERBS,function(e,t){a(t)})}else{a(t)}return this},get:h("get"),post:h("post"),put:h("put"),del:h("delete"),any:h("any"),mapRoutes:function(t){var n=this;e.each(t,function(e,t){n.route.apply(n,t)});return this},eventNamespace:function(){return["sammy-app",this.namespace].join("-")},bind:function(e,t,n){var r=this;if(typeof n=="undefined"){n=t}var i=function(){var e,t,i;e=arguments[0];i=arguments[1];if(i&&i.context){t=i.context;delete i.context}else{t=new r.context_prototype(r,"bind",e.type,i,e.target)}e.cleaned_type=e.type.replace(r.eventNamespace(),"");n.apply(t,[e,i])};if(!this.listeners[e]){this.listeners[e]=[]}this.listeners[e].push(i);if(this.isRunning()){this._listen(e,i)}return this},trigger:function(e,t){this.$element().trigger([e,this.eventNamespace()].join("."),[t]);return this},refresh:function(){this.last_location=null;this.trigger("location-changed");return this},before:function(e,t){if(o(e)){t=e;e={}}this.befores.push([e,t]);return this},after:function(e){return this.bind("event-context-after",e)},around:function(e){this.arounds.push(e);return this},onComplete:function(e){this._onComplete=e;return this},isRunning:function(){return this._running},helpers:function(t){e.extend(this.context_prototype.prototype,t);return this},helper:function(e,t){this.context_prototype.prototype[e]=t;return this},run:function(n){if(this.isRunning()){return false}var r=this;e.each(this.listeners.toHash(),function(t,n){e.each(n,function(e,n){r._listen(t,n)})});this.trigger("run",{start_url:n});this._running=true;this.last_location=null;if(!/\#(.+)/.test(this.getLocation())&&typeof n!="undefined"){this.setLocation(n)}this._checkLocation();this._location_proxy.bind();this.bind("location-changed",function(){r._checkLocation()});this.bind("submit",function(n){if(!t.targetIsThisWindow(n)){return true}var i=r._checkFormSubmission(e(n.target).closest("form"));return i===false?n.preventDefault():false});e(window).bind("unload",function(){r.unload()});return this.trigger("changed")},unload:function(){if(!this.isRunning()){return false}var t=this;this.trigger("unload");this._location_proxy.unbind();this.$element().unbind("submit").removeClass(t.eventNamespace());e.each(this.listeners.toHash(),function(n,r){e.each(r,function(e,r){t._unlisten(n,r)})});this._running=false;return this},destroy:function(){this.unload();delete t.apps[this.element_selector];return this},bindToAllEvents:function(t){var n=this;e.each(this.APP_EVENTS,function(e,r){n.bind(r,t)});e.each(this.listeners.keys(true),function(r,i){if(e.inArray(i,n.APP_EVENTS)==-1){n.bind(i,t)}});return this},routablePath:function(e){return e.replace(i,"")},lookupRoute:function(e,t){var n=this,r=false,i=0,s,o;if(typeof this.routes[e]!="undefined"){s=this.routes[e].length;for(;i<s;i++){o=this.routes[e][i];if(n.routablePath(t).match(o.path)){r=o;break}}}return r},runRoute:function(t,n,r,i){var s=this,o=this.lookupRoute(t,n),u,a,l,c,h,p,d,v,m;if(this.debug){this.log("runRoute",[t,n].join(" "))}this.trigger("run-route",{verb:t,path:n,params:r});if(typeof r=="undefined"){r={}}e.extend(r,this._parseQueryString(n));if(o){this.trigger("route-found",{route:o});if((v=o.path.exec(this.routablePath(n)))!==null){v.shift();e.each(v,function(e,t){if(o.param_names[e]){r[o.param_names[e]]=f(t)}else{if(!r.splat){r.splat=[]}r.splat.push(f(t))}})}u=new this.context_prototype(this,t,n,r,i);l=this.arounds.slice(0);h=this.befores.slice(0);d=[u];if(r.splat){d=d.concat(r.splat)}a=function(){var e,t,n;while(h.length>0){p=h.shift();if(s.contextMatchesOptions(u,p[0])){e=p[1].apply(u,[u]);if(e===false){return false}}}s.last_route=o;u.trigger("event-context-before",{context:u});if(typeof o.callback==="function"){o.callback=[o.callback]}if(o.callback&&o.callback.length){t=-1;n=function(){t++;if(o.callback[t]){e=o.callback[t].apply(u,d)}else if(s._onComplete&&typeof (s._onComplete==="function")){s._onComplete(u)}};d.push(n);n()}u.trigger("event-context-after",{context:u});return e};e.each(l.reverse(),function(e,t){var n=a;a=function(){return t.apply(u,[n])}});try{m=a()}catch(g){this.error(["500 Error",t,n].join(" "),g)}return m}else{return this.notFound(t,n)}},contextMatchesOptions:function(t,n,r){var i=n;if(typeof i==="string"||a(i)){i={path:i}}if(typeof r==="undefined"){r=true}if(e.isEmptyObject(i)){return true}if(u(i.path)){var s,o,f,l;s=[];for(o=0,l=i.path.length;o<l;o+=1){f=e.extend({},i,{path:i.path[o]});s.push(this.contextMatchesOptions(t,f))}var c=e.inArray(true,s)>-1?true:false;return r?c:!c}if(i.only){return this.contextMatchesOptions(t,i.only,true)}else if(i.except){return this.contextMatchesOptions(t,i.except,false)}var h=true,p=true;if(i.path){if(!a(i.path)){i.path=new RegExp(i.path.toString()+"$")}h=i.path.test(t.path)}if(i.verb){if(typeof i.verb==="string"){p=i.verb===t.verb}else{p=i.verb.indexOf(t.verb)>-1}}return r?p&&h:!(p&&h)},getLocation:function(){return this._location_proxy.getLocation()},setLocation:function(e){return this._location_proxy.setLocation(e)},swap:function(e,t){var n=this.$element().html(e);if(o(t)){t(e)}return n},templateCache:function(e,t){if(typeof t!="undefined"){return p[e]=t}else{return p[e]}},clearTemplateCache:function(){return p={}},notFound:function(e,t){var n=this.error(["404 Not Found",e,t].join(" "));return e==="get"?n:true},error:function(e,t){if(!t){t=new Error}t.message=[e,t.message].join(" ");this.trigger("error",{message:t.message,error:t});if(this.raise_errors){throw t}else{this.log(t.message,t)}},_checkLocation:function(){var e,t;e=this.getLocation();if(!this.last_location||this.last_location[0]!="get"||this.last_location[1]!=e){this.last_location=["get",e];t=this.runRoute("get",e)}return t},_getFormVerb:function(t){var n=e(t),r,i;i=n.find('input[name="_method"]');if(i.length>0){r=i.val()}if(!r){r=n[0].getAttribute("method")}if(!r||r===""){r="get"}return e.trim(r.toString().toLowerCase())},_checkFormSubmission:function(t){var n,r,i,s,o;this.trigger("check-form-submission",{form:t});n=e(t);r=n.attr("action")||"";i=this._getFormVerb(n);if(this.debug){this.log("_checkFormSubmission",n,r,i)}if(i==="get"){s=this._serializeFormParams(n);if(s!==""){r+="?"+s}this.setLocation(r);o=false}else{s=e.extend({},this._parseFormParams(n));o=this.runRoute(i,r,s,t.get(0))}return typeof o=="undefined"?false:o},_serializeFormParams:function(e){var t="",n=e.serializeArray(),r;if(n.length>0){t=this._encodeFormPair(n[0].name,n[0].value);for(r=1;r<n.length;r++){t=t+"&"+this._encodeFormPair(n[r].name,n[r].value)}}return t},_encodeFormPair:function(e,t){return l(e)+"="+l(t)},_parseFormParams:function(e){var t={},n=e.serializeArray(),r;for(r=0;r<n.length;r++){t=this._parseParamPair(t,n[r].name,n[r].value)}return t},_parseQueryString:function(e){var t={},n,r,s,o;n=e.match(i);if(n&&n[1]){r=n[1].split("&");for(o=0;o<r.length;o++){s=r[o].split("=");t=this._parseParamPair(t,f(s[0]),f(s[1]||""))}}return t},_parseParamPair:function(e,t,n){if(typeof e[t]!=="undefined"){if(u(e[t])){e[t].push(n)}else{e[t]=[e[t],n]}}else{e[t]=n}return e},_listen:function(e,t){return this.$element().bind([e,this.eventNamespace()].join("."),t)},_unlisten:function(e,t){return this.$element().unbind([e,this.eventNamespace()].join("."),t)}});t.RenderContext=function(e){this.event_context=e;this.callbacks=[];this.previous_content=null;this.content=null;this.next_engine=false;this.waiting=false};t.RenderContext.prototype=e.extend({},t.Object.prototype,{then:function(e){if(!o(e)){if(typeof e==="string"&&e in this.event_context){var t=this.event_context[e];e=function(e){return t.apply(this.event_context,[e])}}else{return this}}var n=this;if(this.waiting){this.callbacks.push(e)}else{this.wait();window.setTimeout(function(){var t=e.apply(n,[n.content,n.previous_content]);if(t!==false){n.next(t)}},0)}return this},wait:function(){this.waiting=true},next:function(e){this.waiting=false;if(typeof e!=="undefined"){this.previous_content=this.content;this.content=e}if(this.callbacks.length>0){this.then(this.callbacks.shift())}},load:function(t,n,r){var i=this;return this.then(function(){var s,u,a,f;if(o(n)){r=n;n={}}else{n=e.extend({},n)}if(r){this.then(r)}if(typeof t==="string"){a=t.match(/\.json$/)||n.json;s=a?n.cache===true:n.cache!==false;i.next_engine=i.event_context.engineFor(t);delete n.cache;delete n.json;if(n.engine){i.next_engine=n.engine;delete n.engine}if(s&&(u=this.event_context.app.templateCache(t))){return u}this.wait();e.ajax(e.extend({url:t,data:{},dataType:a?"json":"text",type:"get",success:function(e){if(s){i.event_context.app.templateCache(t,e)}i.next(e)}},n));return false}else{if(t.nodeType){return t.innerHTML}if(t.selector){i.next_engine=t.attr("data-engine");if(n.clone===false){return t.remove()[0].innerHTML.toString()}else{return t[0].innerHTML.toString()}}}})},loadPartials:function(e){var t;if(e){this.partials=this.partials||{};for(t in e){(function(t,n){t.load(e[n]).then(function(e){this.partials[n]=e})})(this,t)}}return this},render:function(e,t,n,r){if(o(e)&&!t){return this.then(e)}else{if(o(t)){r=n;n=t;t=null}else if(n&&!o(n)){r=n;n=null}return this.loadPartials(r).load(e).interpolate(t,e).then(n)}},partial:function(e,t,n,r){if(o(n)){return this.render(e,t,r).swap(n)}else if(o(t)){return this.render(e,{},n).swap(t)}else{return this.render(e,t,n).swap()}},send:function(){var e=this,t=s(arguments),n=t.shift();if(u(t[0])){t=t[0]}return this.then(function(r){t.push(function(t){e.next(t)});e.wait();n.apply(n,t);return false})},collect:function(t,n,r){var i=this;var s=function(){if(o(t)){n=t;t=this.content}var r=[],s=false;e.each(t,function(e,t){var o=n.apply(i,[e,t]);if(o.jquery&&o.length==1){o=o[0];s=true}r.push(o);return o});return s?r:r.join("")};return r?s():this.then(s)},renderEach:function(t,n,r,i){if(u(n)){i=r;r=n;n=null}return this.load(t).then(function(s){var o=this;if(!r){r=u(this.previous_content)?this.previous_content:[]}if(i){e.each(r,function(e,r){var u={},a=this.next_engine||t;if(n){u[n]=r}else{u=r}i(r,o.event_context.interpolate(s,u,a))})}else{return this.collect(r,function(e,r){var i={},o=this.next_engine||t;if(n){i[n]=r}else{i=r}return this.event_context.interpolate(s,i,o)},true)}})},interpolate:function(e,t,n){var r=this;return this.then(function(i,s){if(!e&&s){e=s}if(this.next_engine){t=this.next_engine;this.next_engine=false}var o=r.event_context.interpolate(i,e,t,this.partials);return n?s+o:o})},swap:function(e){return this.then(function(t){this.event_context.swap(t,e);return t}).trigger("changed",{})},appendTo:function(t){return this.then(function(n){e(t).append(n)}).trigger("changed",{})},prependTo:function(t){return this.then(function(n){e(t).prepend(n)}).trigger("changed",{})},replace:function(t){return this.then(function(n){e(t).html(n)}).trigger("changed",{})},trigger:function(e,t){return this.then(function(n){if(typeof t=="undefined"){t={content:n}}this.event_context.trigger(e,t);return n})}});t.EventContext=function(e,n,r,i,s){this.app=e;this.verb=n;this.path=r;this.params=new t.Object(i);this.target=s};t.EventContext.prototype=e.extend({},t.Object.prototype,{$element:function(){return this.app.$element(s(arguments).shift())},engineFor:function(e){var t=this,n;if(o(e)){return e}e=(e||t.app.template_engine).toString();if(n=e.match(/\.([^\.\?\#]+)$/)){e=n[1]}if(e&&o(t[e])){return t[e]}if(t.app.template_engine){return this.engineFor(t.app.template_engine)}return function(e,t){return e}},interpolate:function(e,t,n,r){return this.engineFor(n).apply(this,[e,t,r])},render:function(e,n,r,i){return(new t.RenderContext(this)).render(e,n,r,i)},renderEach:function(e,n,r,i){return(new t.RenderContext(this)).renderEach(e,n,r,i)},load:function(e,n,r){return(new t.RenderContext(this)).load(e,n,r)},loadPartials:function(e){return(new t.RenderContext(this)).loadPartials(e)},partial:function(e,n,r,i){return(new t.RenderContext(this)).partial(e,n,r,i)},send:function(){var e=new t.RenderContext(this);return e.send.apply(e,arguments)},redirect:function(){var t,n=s(arguments),r=this.app.getLocation(),i=n.length;if(i>1){var o=0,u=[],a=[],f={},l=false;for(;o<i;o++){if(typeof n[o]=="string"){u.push(n[o])}else{e.extend(f,n[o]);l=true}}t=u.join("/");if(l){for(var c in f){a.push(this.app._encodeFormPair(c,f[c]))}t+="?"+a.join("&")}}else{t=n[0]}this.trigger("redirect",{to:t});this.app.last_location=[this.verb,this.path];this.app.setLocation(t);if((new RegExp(t)).test(r)){this.app.trigger("location-changed")}},trigger:function(e,t){if(typeof t=="undefined"){t={}}if(!t.context){t.context=this}return this.app.trigger(e,t)},eventNamespace:function(){return this.app.eventNamespace()},swap:function(e,t){return this.app.swap(e,t)},notFound:function(){return this.app.notFound(this.verb,this.path)},json:function(t){return e.parseJSON(t)},toString:function(){return"Sammy.EventContext: "+[this.verb,this.path,this.params].join(" ")}});return t})